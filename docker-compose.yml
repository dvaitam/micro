services:

  registration-api:
    build: ./registration-api
    ports:
      - "8082:8080"
    environment:
      KAFKA_URL: kafka:9092
      MYSQL_DSN: root:password@tcp(mysql:3306)/micro_auth?parseTime=true
      MESSAGE_SERVICE_URL: http://message-service:8084
      CORS_ALLOWED_ORIGINS: ${CHAT_WEB_ORIGIN},http://localhost:5173,http://127.0.0.1:5173
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      mysql:
        condition: service_healthy
      kafka:
        condition: service_started
      message-service:
        condition: service_started

  email-worker:
    build: ./email-worker
    environment:
      KAFKA_URL: kafka:9092
      MAILGUN_DOMAIN: manchik.co.uk
      MAILGUN_API_KEY: ${MAILGUN_API_KEY:?MAILGUN_API_KEY not set}
      MYSQL_DSN: root:password@tcp(mysql:3306)/micro_auth?parseTime=true
    depends_on:
      mysql:
        condition: service_healthy
      kafka:
        condition: service_started

  chat-service:
    build: ./chat-service
    ports:
      - "8083:8083"
    environment:
      MYSQL_DSN: root:password@tcp(mysql:3306)/micro_auth?parseTime=true
      REDIS_ADDR: redis:6379
      MESSAGE_SERVICE_URL: http://message-service:8084
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      redis:
        condition: service_started
      mysql:
        condition: service_healthy
      message-service:
        condition: service_started

  rtc-service:
    build: ./rtc-service
    ports:
      - "8085:8085"
    environment:
      CORS_ALLOWED_ORIGINS: ${CHAT_WEB_ORIGIN},http://localhost:5173,http://127.0.0.1:5173
      SERVICE_PORT: "8085"
      SESSION_TTL_SECONDS: "900"
      TURN_SERVER_URLS: ${TURN_SERVER_URLS:-turn:turn-server:3478?transport=udp,turn:turn-server:3478?transport=tcp}
      TURN_SHARED_SECRET: ${TURN_SHARED_SECRET:-devsecret}
      TURN_CREDENTIAL_TTL: "600"
    depends_on:
      turn-server:
        condition: service_started

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  turn-server:
    image: coturn/coturn:4.5
    command:
      - --log-file=stdout
      - --listening-port=3478
      - --fingerprint
      - --lt-cred-mech
      - --use-auth-secret
      - --static-auth-secret=${TURN_SHARED_SECRET:-devsecret}
      - --realm=micro-chat
      - --total-quota=300
      - --bps-capacity=0
      - --no-multicast-peers
      - --stale-nonce
      - --min-port=49160
      - --max-port=49200
    ports:
      - "3478:3478"
      - "3478:3478/udp"
      - "49160-49200:49160-49200/udp"
    restart: unless-stopped

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: micro_auth
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -ppassword"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 30s

  cassandra:
    image: cassandra:4.1
    environment:
      CASSANDRA_START_RPC: "true"
      MAX_HEAP_SIZE: 512M
      HEAP_NEWSIZE: 128M
    volumes:
      - cassandra-data:/var/lib/cassandra
    healthcheck:
      test: ["CMD-SHELL", "cqlsh -e 'DESCRIBE KEYSPACES' 127.0.0.1 9042"]
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 60s

  message-service:
    build: ./message-service
    environment:
      CASSANDRA_HOSTS: cassandra
      CASSANDRA_KEYSPACE: chat_data
      SERVICE_PORT: "8084"
      KAFKA_URL: kafka:9092
      MESSAGE_EVENTS_TOPIC: chat-messages
    depends_on:
      cassandra:
        condition: service_healthy
    ports:
      - "8084:8084"

  push-service:
    build: ./push-service
    environment:
      KAFKA_URL: kafka:9092
      KAFKA_TOPIC: chat-messages
      KAFKA_CONSUMER_GROUP: push-service
      MYSQL_DSN: root:password@tcp(mysql:3306)/micro_auth?parseTime=true
      APNS_KEY_PATH: /secrets/AuthKey_3NBGA8639B.p8
      APNS_KEY_ID: 3NBGA8639B
      APNS_TEAM_ID: V35SKYR64Q
      APNS_TOPIC: uk.co.manchik.iMessage
      APNS_ENVIRONMENT: development
    depends_on:
      kafka:
        condition: service_started
      mysql:
        condition: service_healthy
    volumes:
      - /home/ubuntu/AuthKey_3NBGA8639B.p8:/secrets/AuthKey_3NBGA8639B.p8:ro

  chat-web:
    build:
      context: ./chat-web
      args:
        VITE_API_BASE_URL: ${CHAT_API_BASE_URL}
        VITE_WS_URL: ${CHAT_WS_URL}
        VITE_RTC_BASE_URL: ${CHAT_RTC_BASE_URL:-https://webrtc.manchik.co.uk}
    ports:
      - "5173:80"
    depends_on:
      registration-api:
        condition: service_started

  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    environment:
      ZOOKEEPER_CLIENT_PORT: "2181"
      ZOOKEEPER_TICK_TIME: "2000"
    ports:
      - "2181:2181"
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    environment:
      KAFKA_BROKER_ID: "1"
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: "1"
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "1"
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: "0"
    ports:
      - "9092:9092"
    depends_on:
      zookeeper:
        condition: service_started
    volumes:
      - kafka-data:/var/lib/kafka/data

volumes:
  mysql-data:
  cassandra-data:
  zookeeper-data:
  kafka-data:
